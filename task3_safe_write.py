"""
–ó–∞–¥–∞—á–∞ 3. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä safe_write
–í–∞—Ä–∏–∞–Ω—Ç 1: –†–∞–±–æ—Ç–∞ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ (—Å—Ç–∏—Ö–∏, –ø–µ—Å–Ω–∏)
"""

import os
from typing import Optional, TextIO


class safe_write:
    """
    –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    
    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
        with safe_write('poem.txt') as file:
            file.write('–°—Ç—Ä–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞...')
    """
    
    def __init__(self, filename: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
        
        Args:
            filename: –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏
        """
        self.filename = filename
        self.file: Optional[TextIO] = None
        self.content_before_write: Optional[str] = None

    def __enter__(self) -> TextIO:
        """
        –í—Ö–æ–¥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä.
        –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å) –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏.
        
        Returns:
            –û—Ç–∫—Ä—ã—Ç—ã–π —Ñ–∞–π–ª–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏
        """
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        try:
            with open(self.filename, 'r', encoding='utf-8') as f:
                self.content_before_write = f.read()
        except FileNotFoundError:
            self.content_before_write = None

        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏
        self.file = open(self.filename, 'w', encoding='utf-8')
        return self.file

    def __exit__(self, exc_type, exc_val, exc_tb) -> bool:
        """
        –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
        –ï—Å–ª–∏ –±—ã–ª–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ - –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ.
        
        Returns:
            True - –ø–æ–¥–∞–≤–ª—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        """
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª
        if self.file:
            self.file.close()

        # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        if exc_type is not None:
            print(f"–í–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª –±—ã–ª–æ –≤–æ–∑–±—É–∂–¥–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ {exc_type.__name__}")

            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            if self.content_before_write is not None:
                with open(self.filename, 'w', encoding='utf-8') as f:
                    f.write(self.content_before_write)
                print(f"–§–∞–π–ª '{self.filename}' –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")
            else:
                # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ –±—ã–ª–æ, —É–¥–∞–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π
                try:
                    os.remove(self.filename)
                    print(f"–°–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª '{self.filename}' —É–¥–∞–ª–µ–Ω")
                except FileNotFoundError:
                    pass

        # –ü–æ–¥–∞–≤–ª—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        return True


def main():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ safe_write."""
    print("=" * 60)
    print("–ó–ê–î–ê–ß–ê 3: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä safe_write")
    print("=" * 60)
    
    # –ü—Ä–∏–º–µ—Ä 1: –£—Å–ø–µ—à–Ω–∞—è –∑–∞–ø–∏—Å—å
    print("\nüìù [–ü—Ä–∏–º–µ—Ä 1] –£—Å–ø–µ—à–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª:")
    
    poem = """–ë–µ–ª–µ–µ—Ç –ø–∞—Ä—É—Å –æ–¥–∏–Ω–æ–∫–æ–π
–í —Ç—É–º–∞–Ω–µ –º–æ—Ä—è –≥–æ–ª—É–±–æ–º!..
–ß—Ç–æ –∏—â–µ—Ç –æ–Ω –≤ —Å—Ç—Ä–∞–Ω–µ –¥–∞–ª–µ–∫–æ–π?
–ß—Ç–æ –∫–∏–Ω—É–ª –æ–Ω –≤ –∫—Ä–∞—é —Ä–æ–¥–Ω–æ–º?.."""
    
    with safe_write('poem.txt') as file:
        file.write(poem)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    with open('poem.txt', 'r', encoding='utf-8') as file:
        print("\n–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ 'poem.txt':")
        print("-" * 40)
        print(file.read())
        print("-" * 40)
    
    # –ü—Ä–∏–º–µ—Ä 2: –ó–∞–ø–∏—Å—å —Å –æ—à–∏–±–∫–æ–π
    print("\n‚ö†Ô∏è [–ü—Ä–∏–º–µ—Ä 2] –ó–∞–ø–∏—Å—å —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º:")
    
    # –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—à–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    with safe_write('song.txt') as file:
        file.write("–ö–∞—Ç—é—à–∞\n–í—ã—Ö–æ–¥–∏–ª–∞ –Ω–∞ –±–µ—Ä–µ–≥ –ö–∞—Ç—é—à–∞\n")
    
    print("–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –æ—à–∏–±–∫–æ–π...")
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
    try:
        with safe_write('song.txt') as file:
            file.write("–ù–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Å–Ω–∏...\n")
            file.write("–ï—â–µ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞...\n")
            # –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            raise ValueError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏!")
    except ValueError:
        # safe_write –ø–æ–¥–∞–≤–ª—è–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —Ç–∞–∫ —á—Ç–æ –º—ã —Å—é–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–µ–º
        pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –æ—Å—Ç–∞–ª—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º
    with open('song.txt', 'r', encoding='utf-8') as file:
        print("\n–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ 'song.txt' –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏:")
        print("-" * 40)
        print(file.read())
        print("-" * 40)
    
    # –ü—Ä–∏–º–µ—Ä 3: –ó–∞–ø–∏—Å—å –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –æ—à–∏–±–∫–æ–π
    print("\nüÜï [–ü—Ä–∏–º–µ—Ä 3] –ó–∞–ø–∏—Å—å –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –æ—à–∏–±–∫–æ–π:")
    
    with safe_write('new_file.txt') as file:
        file.write("–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è...\n")
        # –í—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        raise TypeError("–û—à–∏–±–∫–∞ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö!")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è
    if not os.path.exists('new_file.txt'):
        print("–§–∞–π–ª 'new_file.txt' –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)")
    else:
        print("‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª —Å–æ–∑–¥–∞–ª—Å—è, —Ö–æ—Ç—è –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã–ª")
    
    print("\n" + "=" * 60)


if __name__ == "__main__":
    main()